## 现状与目标
- 现状：
  - 定时统计任务已使用枚举传参：`StatisticsTaskService` 中通过 `CustomerType` 与 `ProjectType` 的 `getCode()` 传入 SQL 参数（src/main/java/com/simon/case_study_statistics_by_month/service/StatisticsTaskService.java:48-52）。
  - 模拟数据 `gen()` 已使用枚举生成并写入代码值（src/test/java/com/simon/case_study_statistics_by_month/GenMimicDataTest.java:52-58, 73-83）。
  - 领域模型仍以字符串持有类型：`Customer.customerType`、`Project.projectType` 为 `String`（src/main/java/com/simon/case_study_statistics_by_month/domain/Customer.java:14；src/main/java/com/simon/case_study_statistics_by_month/domain/Project.java:14）。
  - 统计查询 SQL 通过参数占位避免硬编码（src/main/resources/mapper/StatisticsMapper.xml:47-49, 76）。
- 目标：
  - 将 `Customer.customerType`、`Project.projectType` 字段改为枚举类型，消除领域层的字符串硬编码。
  - 保持数据库仍存储字符串代码，插入/查询时以枚举 -> 代码转换。
  - 在不设计大量测试用例的前提下，提供端到端的验证方法确保 `bip_dashboard_statistics` 的统计结果正确。

## 代码改造计划
1. 领域模型改造（枚举化字段）
   - 将 `Customer.customerType: String` 改为 `CustomerType customerType`（src/main/java/com/simon/case_study_statistics_by_month/domain/Customer.java:14）。
   - 将 `Project.projectType: String` 改为 `ProjectType projectType`（src/main/java/com/simon/case_study_statistics_by_month/domain/Project.java:14）。
   - Lombok 的链式 `setter` 自动适配为枚举类型。

2. 模拟数据写入调整
   - `GenMimicDataTest.generateCustomers()`：改为 `.setCustomerType(ct)`；批量插入处改为 `ps.setString(4, customer.getCustomerType().getCode())`（src/test/java/com/simon/case_study_statistics_by_month/GenMimicDataTest.java:124-139）。
   - `GenMimicDataTest.generateProjects()`：改为 `.setProjectType(pt)`；批量插入处改为 `ps.setString(4, project.getProjectType().getCode())`（src/test/java/com/simon/case_study_statistics_by_month/GenMimicDataTest.java:141-156）。
   - 该改动保持 DB 仍写入字符串代码，同时领域层使用强类型枚举。

3. 定时统计任务核对
   - 现有实现已通过枚举传参，无需改动：`selectMonthlyStatistics(CustomerType.PROACTIVE.getCode(), CustomerType.COOPERATIVE.getCode(), ProjectType.BFO.getCode())`（src/main/java/com/simon/case_study_statistics_by_month/service/StatisticsTaskService.java:48-52）。
   - 保持 `StatisticsMapper` 方法签名参数为字符串类型即可（src/main/java/com/simon/case_study_statistics_by_month/mapper/StatisticsMapper.java:19-21）。

4. 可选增强（不立即实施）
   - 若后续引入 MyBatis 对 `Customer`/`Project` 的读写映射：可添加 `TypeHandler` 将 `enum <-> code` 自动转换，避免在持久化层手写 `getCode()`。

## 验证方案（端到端，非大量测试）
1. 数据准备
   - 清空相关表（建议 TRUNCATE）：`bip_dashboard_statistics`、`bip_customer`、`bip_project`、`bip_binding`。
   - 运行 `GenMimicDataTest.gen()` 生成模拟数据（src/test/java/com/simon/case_study_statistics_by_month/GenMimicDataTest.java:27-46）。
   - 通过接口手动触发统计：`GET /api/statistics/trigger`（src/main/java/com/simon/case_study_statistics_by_month/controller/StatisticsController.java:31）。

2. 结果核对（同源 SQL 对比法）
   - 使用与生产统计同源的 SQL 生成“期望结果”（`selectMonthlyStatistics`）：
     - 调用 Mapper 或直接执行 `StatisticsMapper.xml` 中的查询（src/main/resources/mapper/StatisticsMapper.xml:20-115）。
     - 传参：`proactiveType=CustomerType.PROACTIVE.getCode()`、`cooperativeType=CustomerType.COOPERATIVE.getCode()`、`bfoProjectType=ProjectType.BFO.getCode()`。
   - 将期望结果与 `bip_dashboard_statistics` 进行对比：
     - 以 `(year, month, retailer_id)` 为键，按 `sub_task` 透视为列进行比对。
     - 示例 SQL（MySQL）：
       ```sql
       SELECT d.year, d.month, d.retailer_id,
              SUM(CASE WHEN d.sub_task='主动型客户数量' THEN CAST(d.result AS UNSIGNED) END) AS proactive_customer_count,
              SUM(CASE WHEN d.sub_task='配合行客户数量' THEN CAST(d.result AS UNSIGNED) END) AS cooperative_customer_count,
              SUM(CASE WHEN d.sub_task='解绑数量' THEN CAST(d.result AS UNSIGNED) END) AS unbinding_count,
              SUM(CASE WHEN d.sub_task='项目信息累计数量' THEN CAST(d.result AS UNSIGNED) END) AS total_project_count,
              SUM(CASE WHEN d.sub_task='有效项目累计数量' THEN CAST(d.result AS UNSIGNED) END) AS active_project_count,
              SUM(CASE WHEN d.sub_task='重要BFO ID项目累计数量' THEN CAST(d.result AS UNSIGNED) END) AS bfo_project_count
       FROM bip_dashboard_statistics d
       GROUP BY d.year, d.month, d.retailer_id;
       ```
     - 将以上结果与 `selectMonthlyStatistics` 的返回逐列比对，若完全一致则验证通过。

3. 数量与一致性检查（轻量但关键）
   - 行量校验：`bip_dashboard_statistics` 的行数应为 `月份数 × 零售商数 × 统计项数(6)`。
   - 累积单调性：同一 `(retailer_id)` 下随月份递增的各项计数应不下降。
   - 键值完整性：`retailer_id` 与 `retailer_name` 成对存在，`del_flag='0'`，`task='项目统计信息'`，`unit='个'`。

4. 现场抽样核对（人工可行）
   - 选取 1 个 `retailer_id` 与 2-3 个连续月份：
     - 直接对底表执行增量统计（当月新增）与窗口累积（截至当月）手工核算，确认与看板表一致。
     - 关注解绑的累计与项目累计在无新增月份的保持不变。

## 风险与兼容性
- 领域模型改为枚举后，仅影响应用内的类型使用；数据库仍为字符串代码，不破坏既有 SQL 与 Mapper。
- 模拟数据插入使用 `JdbcTemplate`，改造后通过 `getCode()` 写库，兼容性良好。
- 若未来需要从 DB 读取 `Customer`/`Project` 至领域对象，建议引入 `TypeHandler` 以避免手写转换。

## 交付与执行顺序
1. 修改 `Customer`、`Project` 字段为枚举；编译通过。
2. 修改 `GenMimicDataTest` 的枚举设置与 `batchInsert` 写库处的 `getCode()`；编译通过。
3. 运行端到端验证：清库→`gen()`→触发统计→SQL 对比与抽样核对。

如确认该方案，后续我将按上述步骤提交具体代码改动并执行验证。