<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.simon.case_study_statistics_by_month.mapper.StatisticsMapper">

    <!-- 统计查询结果映射 -->
    <resultMap id="StatisticsResultMap" type="com.simon.case_study_statistics_by_month.domain.StatisticsResult">
        <result property="yyyyMm" column="yyyy_mm"/>
        <result property="retailerName" column="retailer_name"/>
        <result property="retailerId" column="retailer_id"/>
        <result property="proactiveCustomerCount" column="proactive_customer_count"/>
        <result property="cooperativeCustomerCount" column="cooperative_customer_count"/>
        <result property="unbindingCount" column="unbinding_count"/>
        <result property="totalProjectCount" column="total_project_count"/>
        <result property="activeProjectCount" column="active_project_count"/>
        <result property="bfoProjectCount" column="bfo_project_count"/>
    </resultMap>

    <!-- 月度统计查询 -->
    <select id="selectMonthlyStatistics" resultMap="StatisticsResultMap">
        WITH
        all_customer_months AS (
            SELECT DISTINCT DATE_FORMAT(c.create_time, '%Y-%m') AS yyyy_mm, c.id AS retailer_id
            FROM bip_customer c
            UNION
            SELECT DISTINCT DATE_FORMAT(b.create_time, '%Y-%m') AS yyyy_mm, b.customer_id AS retailer_id
            FROM bip_binding b
            UNION
            SELECT DISTINCT DATE_FORMAT(p.create_time, '%Y-%m') AS yyyy_mm, b.customer_id AS retailer_id
            FROM bip_project p
            JOIN bip_binding b ON b.project_id = p.id
        ),

        customer_info AS (
            SELECT
                c.id AS retailer_id,
                MAX(c.customer_name) as retailer_name
            FROM bip_customer c
            GROUP BY c.id
        ),

        cte1 AS (
            SELECT
                DATE_FORMAT(c.create_time, '%Y-%m') AS yyyy_mm,
                c.id AS retailer_id,
                COUNT(CASE WHEN c.customer_type = #{proactiveType} THEN 1 END) AS new_proactive_customers,
                COUNT(CASE WHEN c.customer_type = #{cooperativeType} THEN 1 END) AS new_cooperative_customers
            FROM
                bip_customer c
            WHERE
                c.del_flag = '0'
            GROUP BY
                yyyy_mm, retailer_id
        ),

        cte2 AS (
            SELECT
                DATE_FORMAT(b.create_time, '%Y-%m') AS yyyy_mm,
                b.customer_id AS retailer_id,
                COUNT(b.id) AS new_unbindings
            FROM
                bip_binding b
            WHERE
                b.del_flag = '1'
            GROUP BY
                yyyy_mm, retailer_id
        ),

        cte3 AS (
            SELECT
                DATE_FORMAT(p.create_time, '%Y-%m') AS yyyy_mm,
                b.customer_id AS retailer_id,
                COUNT(p.id) AS new_total_projects,
                COUNT(CASE WHEN p.del_flag = '0' THEN 1 END) AS new_active_projects,
                COUNT(CASE WHEN p.project_type = #{bfoProjectType} THEN 1 END) AS new_bfo_projects
            FROM
                bip_project p
            JOIN bip_binding b ON b.project_id = p.id
            GROUP BY
                yyyy_mm, retailer_id
        ),

        monthly_increments AS (
            SELECT
                m.yyyy_mm,
                m.retailer_id,
                COALESCE(c1.new_proactive_customers, 0) AS new_proactive_customers,
                COALESCE(c1.new_cooperative_customers, 0) AS new_cooperative_customers,
                COALESCE(c2.new_unbindings, 0) AS new_unbindings,
                COALESCE(c3.new_total_projects, 0) AS new_total_projects,
                COALESCE(c3.new_active_projects, 0) AS new_active_projects,
                COALESCE(c3.new_bfo_projects, 0) AS new_bfo_projects
            FROM all_customer_months m
            LEFT JOIN cte1 c1 ON m.yyyy_mm = c1.yyyy_mm AND m.retailer_id = c1.retailer_id
            LEFT JOIN cte2 c2 ON m.yyyy_mm = c2.yyyy_mm AND m.retailer_id = c2.retailer_id
            LEFT JOIN cte3 c3 ON m.yyyy_mm = c3.yyyy_mm AND m.retailer_id = c3.retailer_id
        )

        SELECT
            i.yyyy_mm,
            ci.retailer_name,
            i.retailer_id,
            SUM(i.new_proactive_customers) OVER (PARTITION BY i.retailer_id ORDER BY i.yyyy_mm) AS proactive_customer_count,
            SUM(i.new_cooperative_customers) OVER (PARTITION BY i.retailer_id ORDER BY i.yyyy_mm) AS cooperative_customer_count,
            SUM(i.new_unbindings) OVER (PARTITION BY i.retailer_id ORDER BY i.yyyy_mm) AS unbinding_count,
            SUM(i.new_total_projects) OVER (PARTITION BY i.retailer_id ORDER BY i.yyyy_mm) AS total_project_count,
            SUM(i.new_active_projects) OVER (PARTITION BY i.retailer_id ORDER BY i.yyyy_mm) AS active_project_count,
            SUM(i.new_bfo_projects) OVER (PARTITION BY i.retailer_id ORDER BY i.yyyy_mm) AS bfo_project_count
        FROM
            monthly_increments i
        LEFT JOIN customer_info ci ON i.retailer_id = ci.retailer_id
        ORDER BY
            ci.retailer_name, i.retailer_id, i.yyyy_mm
    </select>

    <!-- 插入看板统计数据 -->
    <insert id="insertDashboardStatistics">
        INSERT INTO bip_dashboard_statistics (
            id, year, month, area_id, area_name, retailer_name, retailer_id,
            task, sub_task, result, unit, remark, del_flag, created_by, create_time, update_by, update_time
        ) VALUES (
            UUID(), #{year}, #{month}, NULL, NULL, #{retailerName}, #{retailerId},
            #{task}, #{subTask}, #{result}, #{unit}, #{remark}, '0', 'system', NOW(), 'system', NOW()
        )
    </insert>

</mapper>